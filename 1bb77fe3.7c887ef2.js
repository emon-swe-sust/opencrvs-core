(window.webpackJsonp=window.webpackJsonp||[]).push([[11],{136:function(e,t,n){"use strict";n.d(t,"a",(function(){return p})),n.d(t,"b",(function(){return O}));var a=n(0),r=n.n(a);function b(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function i(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function o(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?i(Object(n),!0).forEach((function(t){b(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):i(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function c(e,t){if(null==e)return{};var n,a,r=function(e,t){if(null==e)return{};var n,a,r={},b=Object.keys(e);for(a=0;a<b.length;a++)n=b[a],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var b=Object.getOwnPropertySymbols(e);for(a=0;a<b.length;a++)n=b[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var l=r.a.createContext({}),s=function(e){var t=r.a.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):o(o({},t),e)),n},p=function(e){var t=s(e.components);return r.a.createElement(l.Provider,{value:t},e.children)},d={inlineCode:"code",wrapper:function(e){var t=e.children;return r.a.createElement(r.a.Fragment,{},t)}},u=r.a.forwardRef((function(e,t){var n=e.components,a=e.mdxType,b=e.originalType,i=e.parentName,l=c(e,["components","mdxType","originalType","parentName"]),p=s(n),u=a,O=p["".concat(i,".").concat(u)]||p[u]||d[u]||b;return n?r.a.createElement(O,o(o({ref:t},l),{},{components:n})):r.a.createElement(O,o({ref:t},l))}));function O(e,t){var n=arguments,a=t&&t.mdxType;if("string"==typeof e||a){var b=n.length,i=new Array(b);i[0]=u;var o={};for(var c in t)hasOwnProperty.call(t,c)&&(o[c]=t[c]);o.originalType=e,o.mdxType="string"==typeof e?e:a,i[1]=o;for(var l=2;l<b;l++)i[l]=n[l];return r.a.createElement.apply(null,i)}return r.a.createElement.apply(null,n)}u.displayName="MDXCreateElement"},137:function(e,t,n){"use strict";n.d(t,"b",(function(){return b})),n.d(t,"a",(function(){return i}));var a=n(22),r=n(138);function b(){var e=Object(a.default)().siteConfig,t=(e=void 0===e?{}:e).baseUrl,n=void 0===t?"/":t,b=e.url;return{withBaseUrl:function(e,t){return function(e,t,n,a){var b=void 0===a?{}:a,i=b.forcePrependBaseUrl,o=void 0!==i&&i,c=b.absolute,l=void 0!==c&&c;if(!n)return n;if(n.startsWith("#"))return n;if(Object(r.b)(n))return n;if(o)return t+n;var s=n.startsWith(t)?n:t+n.replace(/^\//,"");return l?e+s:s}(b,n,e,t)}}}function i(e,t){return void 0===t&&(t={}),(0,b().withBaseUrl)(e,t)}},138:function(e,t,n){"use strict";function a(e){return!0===/^(\w*:|\/\/)/.test(e)}function r(e){return void 0!==e&&!a(e)}n.d(t,"b",(function(){return a})),n.d(t,"a",(function(){return r}))},76:function(e,t,n){"use strict";n.r(t),n.d(t,"frontMatter",(function(){return o})),n.d(t,"metadata",(function(){return c})),n.d(t,"toc",(function(){return l})),n.d(t,"default",(function(){return p}));var a=n(3),r=n(7),b=(n(0),n(136)),i=n(137),o={id:"webhooks",title:"Webhook integration"},c={unversionedId:"technology/webhooks",id:"technology/webhooks",isDocsHomePage:!1,title:"Webhook integration",description:"Introduction",source:"@site/docs/technology/Webhooks.mdx",slug:"/technology/webhooks",permalink:"/opencrvs-core/docs/technology/webhooks",version:"current",sidebar:"docs",previous:{title:"Technical interoperability",permalink:"/opencrvs-core/docs/technology/technicalInteroperability"},next:{title:"Mediators and FHIR",permalink:"/opencrvs-core/docs/technology/mediators"}},l=[{value:"Introduction",id:"introduction",children:[]},{value:"Sequence diagram",id:"sequence-diagram",children:[]},{value:"Creating a subscriber endpoint",id:"creating-a-subscriber-endpoint",children:[{value:"Verification Requests",id:"verification-requests",children:[]},{value:"Event Notifications",id:"event-notifications",children:[]}]},{value:"Subscription process",id:"subscription-process",children:[{value:"List available webhooks",id:"list-available-webhooks",children:[]},{value:"Subscribe to a webhook",id:"subscribe-to-a-webhook",children:[]},{value:"Unsubscribe to a webhook",id:"unsubscribe-to-a-webhook",children:[]},{value:"National ID biometrics",id:"national-id-biometrics",children:[]}]}],s={toc:l};function p(e){var t=e.components,n=Object(r.a)(e,["components"]);return Object(b.b)("wrapper",Object(a.a)({},s,n,{components:t,mdxType:"MDXLayout"}),Object(b.b)("h2",{id:"introduction"},"Introduction"),Object(b.b)("p",null,"In order to make OpenCRVS as useful and open as possible to other systems, OpenCRVS publishes the following civil registration events as Webhooks that ",Object(b.b)("a",Object(a.a)({parentName:"p"},{href:"./mediators"}),"mediators")," can subscribe to."),Object(b.b)("ul",null,Object(b.b)("li",{parentName:"ul"},Object(b.b)("strong",{parentName:"li"},"Birth registration")),Object(b.b)("li",{parentName:"ul"},Object(b.b)("strong",{parentName:"li"},"Death registration")),Object(b.b)("li",{parentName:"ul"},Object(b.b)("strong",{parentName:"li"},"Birth certified")),Object(b.b)("li",{parentName:"ul"},Object(b.b)("strong",{parentName:"li"},"Death certified")),Object(b.b)("li",{parentName:"ul"},Object(b.b)("strong",{parentName:"li"},"Birth corrected")),Object(b.b)("li",{parentName:"ul"},Object(b.b)("strong",{parentName:"li"},"Death corrected"))),Object(b.b)("p",null,"Included in these webhooks is be a ",Object(b.b)("strong",{parentName:"p"},"FHIR Resource type and uniqe ID")," to the resource associated. In these cases, a ",Object(b.b)("strong",{parentName:"p"},"FHIR Composition id"),". Once a subscriber receives the event, they can query OpenCRVS for ",Object(b.b)("strong",{parentName:"p"},"demographics, attachments and links to biometric data")," for the registration in a dedicated and secure API."),Object(b.b)("p",null,"Subscribing to an OpenCRVS Webhook requires your system administrator to:"),Object(b.b)("ol",null,Object(b.b)("li",{parentName:"ol"},"SSH into the OpenCRVS manager node and ",Object(b.b)("a",Object(a.a)({parentName:"li"},{href:"./technicalInteroperability"}),"register a new system client")),Object(b.b)("li",{parentName:"ol"},"Securely host the system ",Object(b.b)("inlineCode",{parentName:"li"},"client_id"),", ",Object(b.b)("inlineCode",{parentName:"li"},"client_secret")," and ",Object(b.b)("inlineCode",{parentName:"li"},"sha_secret"),", returned in the registration process, as environment variables your mediator has access to.")),Object(b.b)("p",null,"Subscribing to an OpenCRVS Webhook requires you to develop a mediator. As an example, we have written ",Object(b.b)("strong",{parentName:"p"},Object(b.b)("a",Object(a.a)({parentName:"strong"},{href:"https://github.com/opencrvs/mosip-mediator"}),"this mediator"))," that subscribes to a ",Object(b.b)("strong",{parentName:"p"},"birth registration")," event and retrieves the data required by the ",Object(b.b)("a",Object(a.a)({parentName:"p"},{href:"https://www.mosip.io/"}),"MOSIP - the Modular Open Source Identity Platform")," to register a national ID.:"),Object(b.b)("p",null,"A mediator that subscribes to an OpenCRVS webhook must:"),Object(b.b)("ol",null,Object(b.b)("li",{parentName:"ol"},"Expose endpoints on a secure server that can process HTTPS requests and respond to a Webhook following the ",Object(b.b)("a",Object(a.a)({parentName:"li"},{href:"https://www.w3.org/TR/websub/"}),"WebSub")," pattern."),Object(b.b)("li",{parentName:"ol"},"Authenticate and query OpenCRVS to find a list of available event webhooks."),Object(b.b)("li",{parentName:"ol"},"Authenticate and subscribe to the Webhook of choice."),Object(b.b)("li",{parentName:"ol"},"Respond to the Webhook event as you wish internally, and request further details from OpenHIM to suit your business case. Refer to the ",Object(b.b)("a",Object(a.a)({parentName:"li"},{href:"./mediators"}),"mediator")," page for examples of raw FHIR resources.")),Object(b.b)("p",null,"These steps are explained in detail below."),Object(b.b)("h2",{id:"sequence-diagram"},"Sequence diagram"),Object(b.b)("p",null,"The following sequence diagram describes a Mediator that is developed to receive information from an OpenCRVS Webhook."),Object(b.b)("img",{alt:"mediator-sequence",src:Object(i.a)("img/mediator-sequence.png")}),Object(b.b)("h2",{id:"creating-a-subscriber-endpoint"},"Creating a subscriber endpoint"),Object(b.b)("p",null,"Your microservice mediator must be able to process two types of HTTPS requests: ",Object(b.b)("strong",{parentName:"p"},"Verification Requests")," and ",Object(b.b)("strong",{parentName:"p"},"Event Notifications"),". Since both requests use HTTPs, your server must have a valid TLS or SSL certificate correctly configured and installed."),Object(b.b)("p",null,"The following sections explain what will be in each type of request to these endpoints and how to respond to them."),Object(b.b)("h3",{id:"verification-requests"},"Verification Requests"),Object(b.b)("p",null,"Anytime you try to subscribe to a Webhook, OpenCRVS will send a GET request to this endpoint URL to confirm that your microservice is prepared to receive webhooks."),Object(b.b)("p",null,Object(b.b)("strong",{parentName:"p"},"Sample Verification Request")),Object(b.b)("pre",null,Object(b.b)("code",Object(a.a)({parentName:"pre"},{}),"GET https://www.your-clever-domain-name.com/webhooks?\n  mode=subscribe&\n  challenge=&\n  topic=BIRTH_REGISTERED\n")),Object(b.b)("table",null,Object(b.b)("thead",{parentName:"table"},Object(b.b)("tr",{parentName:"thead"},Object(b.b)("th",Object(a.a)({parentName:"tr"},{align:null}),"Parameter"),Object(b.b)("th",Object(a.a)({parentName:"tr"},{align:null}),"Sample value"),Object(b.b)("th",Object(a.a)({parentName:"tr"},{align:null}),"Description"))),Object(b.b)("tbody",{parentName:"table"},Object(b.b)("tr",{parentName:"tbody"},Object(b.b)("td",Object(a.a)({parentName:"tr"},{align:null}),Object(b.b)("inlineCode",{parentName:"td"},"mode")),Object(b.b)("td",Object(a.a)({parentName:"tr"},{align:null}),Object(b.b)("inlineCode",{parentName:"td"},"subscribe")),Object(b.b)("td",Object(a.a)({parentName:"tr"},{align:null}),"This value will always be set to ",Object(b.b)("inlineCode",{parentName:"td"},"subscribe"))),Object(b.b)("tr",{parentName:"tbody"},Object(b.b)("td",Object(a.a)({parentName:"tr"},{align:null}),Object(b.b)("inlineCode",{parentName:"td"},"challenge")),Object(b.b)("td",Object(a.a)({parentName:"tr"},{align:null}),Object(b.b)("inlineCode",{parentName:"td"},"1158201444")),Object(b.b)("td",Object(a.a)({parentName:"tr"},{align:null}),"A random cryptographic string that you must pass back to OpenCRVS")),Object(b.b)("tr",{parentName:"tbody"},Object(b.b)("td",Object(a.a)({parentName:"tr"},{align:null}),Object(b.b)("inlineCode",{parentName:"td"},"topic")),Object(b.b)("td",Object(a.a)({parentName:"tr"},{align:null}),Object(b.b)("inlineCode",{parentName:"td"},"BIRTH_REGISTERED")),Object(b.b)("td",Object(a.a)({parentName:"tr"},{align:null}),"A supported OpenCRVS event type string that will trigger this webhook")))),Object(b.b)("p",null,"Note: The supported events and associated topic strings are explained later in this document when studying the subscription process"),Object(b.b)("p",null,Object(b.b)("strong",{parentName:"p"},"Validating Verification Requests")),Object(b.b)("p",null,"Whenever your endpoint receives a verification request, it must:"),Object(b.b)("p",null,"Verify that the ",Object(b.b)("inlineCode",{parentName:"p"},"topic")," value matches the event you're trying to subscribe to.\nRespond with the following object:"),Object(b.b)("pre",null,Object(b.b)("code",Object(a.a)({parentName:"pre"},{}),'{\n    "challenge": "1158201444"\n}\n\n')),Object(b.b)("h3",{id:"event-notifications"},"Event Notifications"),Object(b.b)("p",null,"When you configure your Webhooks product, you will subscribe to specific events. Whenever there's a a new event created, we will send your endpoint a POST request with a JSON payload describing the event ",Object(b.b)("strong",{parentName:"p"},"FHIR Compostion ID"),"."),Object(b.b)("p",null,"For example, if you subscribed to the birth registration event, we would send you a POST request to the same URL as the ",Object(b.b)("strong",{parentName:"p"},"Verification request")," URL that would look something like this:"),Object(b.b)("p",null,"The property ",Object(b.b)("inlineCode",{parentName:"p"},"context")," contains the FHIR bundles that are required for successfully processing an action. In our current birth registration webhook we have included all the required information that the ",Object(b.b)("a",Object(a.a)({parentName:"p"},{href:"https://www.mosip.io/"}),"MOSIP - the Modular Open Source Identity Platform")," requires in order to create a National ID number as an example."),Object(b.b)("p",null,"Links to biometric documents that are hosted by a 3rd party vendor service such as ",Object(b.b)("a",Object(a.a)({parentName:"p"},{href:"https://www.simprints.com/"}),"Simprints")," could be contained here as additional DocumentReferences thus connecting OpenCRVS to a functional and foundational National ID system."),Object(b.b)("p",null,"See the bottom of this page for an understanding of how the Simprints application could work alongside OpenCRVS and MOSIP to capture biometrics during event registration."),Object(b.b)("pre",null,Object(b.b)("code",Object(a.a)({parentName:"pre"},{}),'POST / HTTPS/1.1\nContent-Type: application/json\nX-Hub-Signature: sha1={super-long-SHA1-signature}\n\n{\n    "payload": {\n        "id": "531e9275-40e4-4ab5-a12c-6fa74d7b5b61",\n        "timestamp": "2019-12-12T10:53:43-08:00",\n        "event": {\n            "hub": {\n                "topic": "BIRTH_REGISTERED"\n            }\n        }\n    }\n    "url": "",\n    "hmac": "sha256=1d51fb6d-8636abe2-affb-4238-8bff-200ed3652d1et-dhrhd55",\n    context: [{\n        "resourceType": "Bundle",\n        "entry": [\n            {\n            "resource": {\n                "resourceType": "Task",\n                "status": "requested",\n                "code": {\n                "coding": [\n                    { "system": "http://opencrvs.org/specs/types", "code": "BIRTH" }\n                ]\n                },\n                "focus": {\n                "reference": "Composition/e9e2ff8d-1eac-412b-8bbc-408e90276a3f"\n                },\n                "identifier": [\n                {\n                    "system": "http://opencrvs.org/specs/id/draft-id",\n                    "value": "53fe6974-6140-4e50-afc7-998a9018709b"\n                },\n                {\n                    "system": "http://opencrvs.org/specs/id/birth-tracking-id",\n                    "value": "B6E6YJB"\n                },\n                {\n                    "system": "http://opencrvs.org/specs/id/birth-registration-number",\n                    "value": "2020B6E6YJB"\n                }\n                ],\n                "extension": [\n                {\n                    "url": "http://opencrvs.org/specs/extension/contact-person",\n                    "valueString": "MOTHER"\n                },\n                {\n                    "url": "http://opencrvs.org/specs/extension/contact-relationship",\n                    "valueString": ""\n                },\n                {\n                    "url": "http://opencrvs.org/specs/extension/contact-person-phone-number",\n                    "valueString": "+260965656563"\n                },\n                {\n                    "url": "http://opencrvs.org/specs/extension/timeLoggedMS",\n                    "valueInteger": 52942\n                },\n                {\n                    "url": "http://opencrvs.org/specs/extension/regLastUser",\n                    "valueReference": {\n                    "reference": "Practitioner/c3355b48-7790-43c7-b8f0-10c7316f9bed"\n                    }\n                },\n                {\n                    "url": "http://opencrvs.org/specs/extension/regLastLocation",\n                    "valueReference": {\n                    "reference": "Location/1b4092e0-d391-45cd-89d4-162a81f0f63f"\n                    }\n                },\n                {\n                    "url": "http://opencrvs.org/specs/extension/regLastOffice",\n                    "valueReference": {\n                    "reference": "Location/4ec9c980-0b2f-436a-b49e-203e1e601620"\n                    }\n                }\n                ],\n                "lastModified": "2020-09-27T09:15:20.015Z",\n                "businessStatus": {\n                "coding": [\n                    {\n                    "system": "http://opencrvs.org/specs/reg-status",\n                    "code": "REGISTERED"\n                    }\n                ]\n                },\n                "meta": {\n                "lastUpdated": "2020-09-27T09:15:20.040+00:00",\n                "versionId": "cfbefeac-bda0-4339-9745-9d54e7816c7d"\n                },\n                "id": "60ec435c-1370-4314-ab0b-f44507f0db24"\n            }\n            },\n            {\n            "resource": {\n                "resourceType": "Patient",\n                "active": true,\n                "name": [{ "use": "en", "given": ["esrgstg"], "family": ["srthsrt"] }],\n                "gender": "male",\n                "birthDate": "2019-12-23",\n                "multipleBirthInteger": 1,\n                "meta": {\n                "lastUpdated": "2020-09-27T09:15:20.166+00:00",\n                "versionId": "9f5f1a5e-7059-4f5b-bf2f-8aa4f641b37c"\n                },\n                "id": "1e9ca16b-7c9a-469d-8101-ddd0db229077",\n                "identifier": [\n                { "type": "BIRTH_REGISTRATION_NUMBER", "value": "2020B6E6YJB" }\n                ]\n            }\n            },\n            {\n            "resource": {\n                "resourceType": "DocumentReference",\n                "masterIdentifier": {\n                "system": "urn:ietf:rfc:3986",\n                "value": "d3240515-3d90-4f1a-bbb6-6530477565bd"\n                },\n                "status": "current",\n                "content": [\n                {\n                    "attachment": {\n                    "contentType": "image/png",\n                    "data": "data:image/png;base64,iVBORw0KJLX..."\n                    }\n                }\n                ],\n                "type": {\n                "coding": [\n                    {\n                    "system": "http://opencrvs.org/specs/supporting-doc-type",\n                    "code": "NATIONAL_ID_FRONT"\n                    }\n                ]\n                },\n                "subject": { "display": "MOTHER" },\n                "meta": {\n                "lastUpdated": "2020-09-27T09:15:20.042+00:00",\n                "versionId": "0307d10f-f2c1-42be-a0d3-b09c268a38cf"\n                },\n                "id": "bf503f30-1d0a-40dc-908f-9c0d5e9cdf23"\n            }\n            }\n        ]\n        }]\n}\n')),Object(b.b)("table",null,Object(b.b)("thead",{parentName:"table"},Object(b.b)("tr",{parentName:"thead"},Object(b.b)("th",Object(a.a)({parentName:"tr"},{align:null}),"Parameter"),Object(b.b)("th",Object(a.a)({parentName:"tr"},{align:null}),"Sample value"),Object(b.b)("th",Object(a.a)({parentName:"tr"},{align:null}),"Description"))),Object(b.b)("tbody",{parentName:"table"},Object(b.b)("tr",{parentName:"tbody"},Object(b.b)("td",Object(a.a)({parentName:"tr"},{align:null}),Object(b.b)("inlineCode",{parentName:"td"},"payload.id")),Object(b.b)("td",Object(a.a)({parentName:"tr"},{align:null}),Object(b.b)("inlineCode",{parentName:"td"},"531e9275-40e4-4ab5-a12c-6fa74d7b5b61")),Object(b.b)("td",Object(a.a)({parentName:"tr"},{align:null}),"The unique ",Object(b.b)("inlineCode",{parentName:"td"},"id")," for this webhook. Helpful when debugging.")),Object(b.b)("tr",{parentName:"tbody"},Object(b.b)("td",Object(a.a)({parentName:"tr"},{align:null}),Object(b.b)("inlineCode",{parentName:"td"},"payload.timestamp")),Object(b.b)("td",Object(a.a)({parentName:"tr"},{align:null}),Object(b.b)("inlineCode",{parentName:"td"},"2019-12-12T10:53:43-08:00")),Object(b.b)("td",Object(a.a)({parentName:"tr"},{align:null}),"A timestamp identifying the time that the webhook was created")),Object(b.b)("tr",{parentName:"tbody"},Object(b.b)("td",Object(a.a)({parentName:"tr"},{align:null}),Object(b.b)("inlineCode",{parentName:"td"},"payload.event.hub.topic")),Object(b.b)("td",Object(a.a)({parentName:"tr"},{align:null}),Object(b.b)("inlineCode",{parentName:"td"},"BIRTH_REGISTERED")),Object(b.b)("td",Object(a.a)({parentName:"tr"},{align:null}),"A supported OpenCRVS event type string that triggered this webhook.")),Object(b.b)("tr",{parentName:"tbody"},Object(b.b)("td",Object(a.a)({parentName:"tr"},{align:null}),Object(b.b)("inlineCode",{parentName:"td"},"url")),Object(b.b)("td",Object(a.a)({parentName:"tr"},{align:null}),Object(b.b)("inlineCode",{parentName:"td"},"https://www.your-clever-domain-name.com/webhooks")),Object(b.b)("td",Object(a.a)({parentName:"tr"},{align:null}),"The URL that is notified by this webhook")),Object(b.b)("tr",{parentName:"tbody"},Object(b.b)("td",Object(a.a)({parentName:"tr"},{align:null}),Object(b.b)("inlineCode",{parentName:"td"},"hmac")),Object(b.b)("td",Object(a.a)({parentName:"tr"},{align:null}),Object(b.b)("inlineCode",{parentName:"td"},"sha256=d14a028c2a3a2bc9476102bb288234c415a2b01f828ea62ac5b3e42f")),Object(b.b)("td",Object(a.a)({parentName:"tr"},{align:null}),"The request signature that is created using your ",Object(b.b)("inlineCode",{parentName:"td"},"sha_secret")," explained below.")),Object(b.b)("tr",{parentName:"tbody"},Object(b.b)("td",Object(a.a)({parentName:"tr"},{align:null}),Object(b.b)("inlineCode",{parentName:"td"},"context")),Object(b.b)("td",Object(a.a)({parentName:"tr"},{align:null}),Object(b.b)("inlineCode",{parentName:"td"},"[{ ... }]")),Object(b.b)("td",Object(a.a)({parentName:"tr"},{align:null}),"The ",Object(b.b)("a",Object(a.a)({parentName:"td"},{href:"https://www.hl7.org/fhir/resource.html"}),"FHIR resources")," bundle associated with the target of this webhook.")))),Object(b.b)("p",null,Object(b.b)("strong",{parentName:"p"},"Validating Payloads")),Object(b.b)("p",null,"We sign all Event Notification payloads with an HMAC ",Object(b.b)("strong",{parentName:"p"},"SHA256")," hash and include the hash in the request's ",Object(b.b)("inlineCode",{parentName:"p"},"hmac")," property, preceded with ",Object(b.b)("inlineCode",{parentName:"p"},"sha256="),". You should validate this against your ",Object(b.b)("inlineCode",{parentName:"p"},"sha_secret")," environment variable."),Object(b.b)("p",null,"This ",Object(b.b)("a",Object(a.a)({parentName:"p"},{href:"https://github.com/opencrvs/opencrvs-core/blob/c20e50af197be8e4423746a3bb1d4eb6cbe64353/packages/webhooks/src/features/event/service.ts#L19"}),"method")," shows how we create the signature to help you understand how you might create a similar hash and compare. You can confirm that this data is genuine."),Object(b.b)("p",null,"To validate the payload in a similar way to our method:"),Object(b.b)("p",null,"Generate a ",Object(b.b)("strong",{parentName:"p"},"SHA256")," signature using the ",Object(b.b)("inlineCode",{parentName:"p"},"context")," array contents at position ","[0]"," as the ",Object(b.b)("inlineCode",{parentName:"p"},"rawBody")," . ",Object(b.b)("inlineCode",{parentName:"p"},"signingSecret")," is your OpenCRVS ",Object(b.b)("inlineCode",{parentName:"p"},"sha_secret"),", available to you as an environment variable and generated via the ",Object(b.b)("a",Object(a.a)({parentName:"p"},{href:"./technicalInteroperability"}),"register")," step. ",Object(b.b)("inlineCode",{parentName:"p"},"requestSigningVersion")," is ",Object(b.b)("inlineCode",{parentName:"p"},'"sha256"'),"\nCompare your signature to the ",Object(b.b)("inlineCode",{parentName:"p"},"hmac")," prop. If the signatures match, the payload is genuine."),Object(b.b)("p",null,"Please note that we generate the signature using an escaped unicode version of the payload, with lowercase hex digits. If you just calculate against the decoded bytes, you will end up with a different signature. For example, the string ",Object(b.b)("inlineCode",{parentName:"p"},"\xe4\xf6\xe5")," should be escaped to ",Object(b.b)("inlineCode",{parentName:"p"},"\\u00e4\\u00f6\\u00e5"),"."),Object(b.b)("p",null,Object(b.b)("strong",{parentName:"p"},"Responding to Event Notifications")),Object(b.b)("p",null,"Your endpoint should respond to all Event Notifications with ",Object(b.b)("inlineCode",{parentName:"p"},"200 OK HTTPS"),"."),Object(b.b)("p",null,Object(b.b)("strong",{parentName:"p"},"Frequency"),"\nBe sure to adjust your servers to handle each Webhook individually and at any time."),Object(b.b)("p",null,"Unacknowledged responses are retried according to the capabilities of our library used ",Object(b.b)("a",Object(a.a)({parentName:"p"},{href:"https://docs.bullmq.io/what-is-bullmq"}),"bullmq"),"."),Object(b.b)("h2",{id:"subscription-process"},"Subscription process"),Object(b.b)("p",null,"Firstly, ensure that you have correctly configured your subscriber endpoint above to respond to ",Object(b.b)("strong",{parentName:"p"},"Verification Requests")," and ",Object(b.b)("strong",{parentName:"p"},"Event Notifications"),"."),Object(b.b)("p",null,"Next, your subscription service must ",Object(b.b)("a",Object(a.a)({parentName:"p"},{href:"./technicalInteroperability"}),"request an Authorization Bearer token")," using your ",Object(b.b)("inlineCode",{parentName:"p"},"client_id")," and ",Object(b.b)("inlineCode",{parentName:"p"},"client_secret"),"."),Object(b.b)("h3",{id:"list-available-webhooks"},"List available webhooks"),Object(b.b)("p",null,"This API returns webhooks that are owned by the authenticated client service"),Object(b.b)("p",null,Object(b.b)("strong",{parentName:"p"},"URL")),Object(b.b)("pre",null,Object(b.b)("code",Object(a.a)({parentName:"pre"},{}),"GET https://webhooks.<your-open-crvs-host.com>/webhooks\n")),Object(b.b)("p",null,Object(b.b)("strong",{parentName:"p"},"Request headers")),Object(b.b)("pre",null,Object(b.b)("code",Object(a.a)({parentName:"pre"},{}),"Content-Type: application/json\nAuthorization: Bearer <token>\n")),Object(b.b)("p",null,Object(b.b)("strong",{parentName:"p"},"Response payload")),Object(b.b)("p",null,"Example json"),Object(b.b)("pre",null,Object(b.b)("code",Object(a.a)({parentName:"pre"},{}),'{\n  "entries": [\n    {\n        "id": "531e9275-40e4-4ab5-a12c-6fa74d7b5b61",\n        "callback": "https://www.your-clever-domain-name.com/webhooks",\n        "createdAt": "2019-12-12T10:53:43-08:00",\n        "createdBy": {\n            "client_id": "8636abe2-affb-4238-8bff-200ed3652d1e",\n            "type": "api",\n            "username": "sys.admin",\n            "name": "Euan Millar"\n        }\n        "topic": "BIRTH_REGISTERED"\n    }\n  ]\n}\n')),Object(b.b)("h3",{id:"subscribe-to-a-webhook"},"Subscribe to a webhook"),Object(b.b)("p",null,"This API subscribes a client service to an OpenCRVS webhook using a supported OpenCRVS event type string as a trigger."),Object(b.b)("p",null,Object(b.b)("strong",{parentName:"p"},"URL")),Object(b.b)("pre",null,Object(b.b)("code",Object(a.a)({parentName:"pre"},{}),"POST https://webhooks.<your-open-crvs-host.com>/webhooks\n")),Object(b.b)("p",null,Object(b.b)("strong",{parentName:"p"},"Request headers")),Object(b.b)("pre",null,Object(b.b)("code",Object(a.a)({parentName:"pre"},{}),"Content-Type: application/json\nAuthorization: Bearer <token>\n")),Object(b.b)("p",null,Object(b.b)("strong",{parentName:"p"},"Request payload")),Object(b.b)("pre",null,Object(b.b)("code",Object(a.a)({parentName:"pre"},{}),'{\n    "hub": {\n        "callback": "https://www.your-clever-domain-name.com/webhooks",\n        "mode": "subscribe",\n        "topic": "BIRTH_REGISTERED",\n        "secret": "d04aec67-1ef4-467a-a5a8-fa5c89ad71ce"\n    }\n\n}\n\n\n')),Object(b.b)("p",null,"Parameters contained within the ",Object(b.b)("inlineCode",{parentName:"p"},"hub")," object:"),Object(b.b)("table",null,Object(b.b)("thead",{parentName:"table"},Object(b.b)("tr",{parentName:"thead"},Object(b.b)("th",Object(a.a)({parentName:"tr"},{align:null}),"Parameter"),Object(b.b)("th",Object(a.a)({parentName:"tr"},{align:null}),"Sample value"),Object(b.b)("th",Object(a.a)({parentName:"tr"},{align:null}),"Description"))),Object(b.b)("tbody",{parentName:"table"},Object(b.b)("tr",{parentName:"tbody"},Object(b.b)("td",Object(a.a)({parentName:"tr"},{align:null}),Object(b.b)("inlineCode",{parentName:"td"},"callback")),Object(b.b)("td",Object(a.a)({parentName:"tr"},{align:null}),Object(b.b)("inlineCode",{parentName:"td"},"https://www.your-clever-domain-name.com/webhooks")),Object(b.b)("td",Object(a.a)({parentName:"tr"},{align:null}),"The URL address that will be requested when the event occurs.")),Object(b.b)("tr",{parentName:"tbody"},Object(b.b)("td",Object(a.a)({parentName:"tr"},{align:null}),Object(b.b)("inlineCode",{parentName:"td"},"mode")),Object(b.b)("td",Object(a.a)({parentName:"tr"},{align:null}),Object(b.b)("inlineCode",{parentName:"td"},"subscribe")),Object(b.b)("td",Object(a.a)({parentName:"tr"},{align:null}),"Always set to ",Object(b.b)("inlineCode",{parentName:"td"},"subscribe")," for this action.")),Object(b.b)("tr",{parentName:"tbody"},Object(b.b)("td",Object(a.a)({parentName:"tr"},{align:null}),Object(b.b)("inlineCode",{parentName:"td"},"topic")),Object(b.b)("td",Object(a.a)({parentName:"tr"},{align:null}),Object(b.b)("inlineCode",{parentName:"td"},"BIRTH_REGISTERED")),Object(b.b)("td",Object(a.a)({parentName:"tr"},{align:null}),"A supported OpenCRVS event type string that will trigger this webhook.")),Object(b.b)("tr",{parentName:"tbody"},Object(b.b)("td",Object(a.a)({parentName:"tr"},{align:null}),Object(b.b)("inlineCode",{parentName:"td"},"secret")),Object(b.b)("td",Object(a.a)({parentName:"tr"},{align:null}),Object(b.b)("inlineCode",{parentName:"td"},"d04aec67-1ef4-467a-a5a8-fa5c89ad71ce")),Object(b.b)("td",Object(a.a)({parentName:"tr"},{align:null}),"Your OpenCRVS ",Object(b.b)("inlineCode",{parentName:"td"},"sha_secret"),", available to you via the mediator ",Object(b.b)("a",Object(a.a)({parentName:"td"},{href:"./technicalInteroperability"}),"register")," step.")))),Object(b.b)("p",null,"The supported events and associated topic string:"),Object(b.b)("table",null,Object(b.b)("thead",{parentName:"table"},Object(b.b)("tr",{parentName:"thead"},Object(b.b)("th",Object(a.a)({parentName:"tr"},{align:null}),"Webhook event"),Object(b.b)("th",Object(a.a)({parentName:"tr"},{align:null}),"trigger"))),Object(b.b)("tbody",{parentName:"table"},Object(b.b)("tr",{parentName:"tbody"},Object(b.b)("td",Object(a.a)({parentName:"tr"},{align:null}),Object(b.b)("inlineCode",{parentName:"td"},"Birth registration")),Object(b.b)("td",Object(a.a)({parentName:"tr"},{align:null}),Object(b.b)("inlineCode",{parentName:"td"},"BIRTH_REGISTERED"))),Object(b.b)("tr",{parentName:"tbody"},Object(b.b)("td",Object(a.a)({parentName:"tr"},{align:null}),Object(b.b)("inlineCode",{parentName:"td"},"Death registration")),Object(b.b)("td",Object(a.a)({parentName:"tr"},{align:null}),Object(b.b)("inlineCode",{parentName:"td"},"DEATH_REGISTERED"))),Object(b.b)("tr",{parentName:"tbody"},Object(b.b)("td",Object(a.a)({parentName:"tr"},{align:null}),Object(b.b)("inlineCode",{parentName:"td"},"Birth certified")),Object(b.b)("td",Object(a.a)({parentName:"tr"},{align:null}),Object(b.b)("inlineCode",{parentName:"td"},"BIRTH_CERTIFIED"))),Object(b.b)("tr",{parentName:"tbody"},Object(b.b)("td",Object(a.a)({parentName:"tr"},{align:null}),Object(b.b)("inlineCode",{parentName:"td"},"Death certified")),Object(b.b)("td",Object(a.a)({parentName:"tr"},{align:null}),Object(b.b)("inlineCode",{parentName:"td"},"DEATH_CERTIFIED"))),Object(b.b)("tr",{parentName:"tbody"},Object(b.b)("td",Object(a.a)({parentName:"tr"},{align:null}),Object(b.b)("inlineCode",{parentName:"td"},"Birth corrected")),Object(b.b)("td",Object(a.a)({parentName:"tr"},{align:null}),Object(b.b)("inlineCode",{parentName:"td"},"BIRTH_CORRECTED"))),Object(b.b)("tr",{parentName:"tbody"},Object(b.b)("td",Object(a.a)({parentName:"tr"},{align:null}),Object(b.b)("inlineCode",{parentName:"td"},"Death corrected")),Object(b.b)("td",Object(a.a)({parentName:"tr"},{align:null}),Object(b.b)("inlineCode",{parentName:"td"},"DEATH_CORRECTED"))))),Object(b.b)("p",null,Object(b.b)("strong",{parentName:"p"},"Response payload")),Object(b.b)("p",null,"The subscribe process will test the authenticity of the ",Object(b.b)("inlineCode",{parentName:"p"},"sha_secret")," and additionally make a test GET request to the ",Object(b.b)("strong",{parentName:"p"},"Verification Request")),Object(b.b)("p",null,"Provided all is successfully completeed, your webhook will be subscribed and you will receive a ",Object(b.b)("strong",{parentName:"p"},"202")," status code and empty response."),Object(b.b)("h3",{id:"unsubscribe-to-a-webhook"},"Unsubscribe to a webhook"),Object(b.b)("p",null,"This API unsubscribes a client service to an OpenCRVS webhook using the webhook id."),Object(b.b)("p",null,Object(b.b)("strong",{parentName:"p"},"URL")),Object(b.b)("pre",null,Object(b.b)("code",Object(a.a)({parentName:"pre"},{}),"DELETE https://webhooks.<your-open-crvs-host.com>/webhooks/<your-webhook-id>\n")),Object(b.b)("p",null,Object(b.b)("strong",{parentName:"p"},"Request headers")),Object(b.b)("pre",null,Object(b.b)("code",Object(a.a)({parentName:"pre"},{}),"Content-Type: application/json\nAuthorization: Bearer <token>\n")),Object(b.b)("p",null,Object(b.b)("strong",{parentName:"p"},"Response")),Object(b.b)("p",null,Object(b.b)("strong",{parentName:"p"},"204")," status code and an empty response will be returned when the webhook has been successfully deleted."),Object(b.b)("h3",{id:"national-id-biometrics"},"National ID biometrics"),Object(b.b)("p",null,"The Webhook example for birth registration we have introduced here shows how OpenCRVS can integrate with the ",Object(b.b)("a",Object(a.a)({parentName:"p"},{href:"https://www.mosip.io/"}),"MOSIP - the Modular Open Source Identity Platform")," and share the minimum requireed information necessary to generate a National ID for a child."),Object(b.b)("p",null,"We are also grateful to the vendor ",Object(b.b)("a",Object(a.a)({parentName:"p"},{href:"https://www.simprints.com/"}),"Simprints")," who contributed the following proposed flow to capture biometrics during birth registration using their hardware."),Object(b.b)("img",{alt:"Simprints integration",src:Object(i.a)("assets/technology/Simprints-OpenCRVS.jpg")}))}p.isMDXComponent=!0}}]);